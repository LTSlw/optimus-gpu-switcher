image: debian:latest

stages:
#  - build
  - update_latest
  - deploy

#create_zip:
#  stage: build
#  script:
#    - echo "Creating zip file"
#    - apt-get update && apt-get install -y zip
#    - zip -r latest.zip contents metadata.json
#  artifacts:
#    paths:
#      - latest.zip
#  only:
#    - main

update_latest_tag:
  stage: update_latest
  script:
    - apt-get update && apt-get install -y git
    - git config --global user.email "eniel160990@gmail.com"
    - git config --global user.name "GitLab CI"
    - git fetch --tags --force  # Sincroniza los tags con el remoto
    - git tag -f latest $CI_COMMIT_SHA  # Forzar la creación/actualización del tag 'latest'
    - git remote set-url origin https://${GITLAB_USERNAME}:${PERSONAL_ACCESS_TOKEN}@www.opencode.net/enlroma/optimus-gpu-switcher.git
    - git push -f origin latest # Sube el tag 'latest' al repositorio remoto
    
  only:
    - main


release:
  stage: deploy
  script:
    - echo "Releasing"
    - apt-get update && apt-get install -y curl
    - >
      curl --header "Project-ID: $CI_PROJECT_ID" --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" 
      --data "name=Release $CI_COMMIT_TAG" --data "tag_name=$CI_COMMIT_TAG" 
      --data "description=Release of $CI_COMMIT_TAG" 
      "https://www.opencode.net/api/v4/projects/$CI_PROJECT_ID/releases"
  only:
    - main
